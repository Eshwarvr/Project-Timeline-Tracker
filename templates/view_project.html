{% extends "base.html" %}

{% block title %}{{ project.project_name }}{% endblock %}

{% block content %}
<!-- Project Header -->
<div class="row mb-4">
    <div class="col-md-6">
        <h1>{{ project.project_name }}</h1>
        <p class="text-muted"><i class="bi bi-person-circle"></i> Client: {{ project.client_name }}</p>
    </div>
    <div class="col-md-6 text-end d-flex justify-content-end align-items-start flex-wrap gap-2">
        <a href="/add-milestone/{{ project.id }}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add Milestone</a>
        <a href="{{ url_for('edit_project', project_id=project.id) }}" class="btn btn-success"> <i class="bi bi-pencil-square"></i> Edit Project </a>
        <a href="/" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back</a>
    </div>
</div>

<!-- Combined Row: Details (3/4) + Progress (1/4) -->
<div class="row mb-4 g-4">
  <!-- Project Details: 3/4 -->
  <div class="col-12 col-md-8 col-lg-9">
    <div class="card shadow h-100">
      <div class="card-header bg-white text-dark border-bottom">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Project Details</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <strong><i class="bi bi-calendar-check"></i> Start Date:</strong><br>
            <span class="text-muted">{{ project.start_date.strftime('%d-%m-%Y') }}</span>
          </div>
          <div class="col-md-3">
            <strong><i class="bi bi-calendar-x"></i> End Date:</strong><br>
            <span class="text-muted">{{ project.end_date.strftime('%d-%m-%Y') }}</span>
          </div>
          <div class="col-md-3">
            <strong><i class="bi bi-list-task"></i> Total Milestones:</strong><br>
            <span class="badge bg-info fs-6">{{ project.milestones|length }}</span>
          </div>
          <div class="col-md-3">
            <strong><i class="bi bi-flag"></i> Status:</strong><br>
            <form method="post" action="{{ url_for('toggle_status', project_id=project.id) }}" style="display:inline;">
              {% if project.status == "Completed" %}
                <button type="submit" class="btn btn-success btn-sm">
                  <i class="bi bi-check-circle"></i> Completed
                </button>
              {% else %}
                <button type="submit" class="btn btn-secondary btn-sm">
                  <i class="bi bi-circle"></i> Not Completed
                </button>
              {% endif %}
            </form>
            {% if project.status == "Overdue" %}
              <span class="badge bg-danger ms-2">Overdue</span>
            {% elif project.status == "In Progress" %}
              <span class="badge bg-warning text-dark ms-2">In Progress</span>
            {% elif project.status == "Not Started" %}
              <span class="badge bg-secondary ms-2">Not Started</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Progress: 1/4 -->
  <div class="col-12 col-md-4 col-lg-3">
    <div class="card shadow h-100 border-success">
      <div class="card-header bg-white text-dark border-bottom">
        <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Project Progress</h5>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-bold fs-6">Completion Status:</span>
          <span class="badge bg-primary">{{ completed_milestones }}/{{ total_milestones }} Milestones Completed</span>
        </div>
        <div class="progress" style="height: 28px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated
            {% if completion_percentage == 100 %}bg-success
            {% elif completion_percentage >= 75 %}bg-info
            {% elif completion_percentage >= 50 %}bg-warning
            {% else %}bg-danger{% endif %}"
            role="progressbar"
            style="width: {{ completion_percentage }}%;"
            aria-valuenow="{{ completion_percentage }}"
            aria-valuemin="0"
            aria-valuemax="100">
            <strong>{{ completion_percentage }}%</strong>
          </div>
        </div>
        <div class="mt-2 text-muted small">
          {% if completion_percentage == 100 %}
            <i class="bi bi-check-circle-fill text-success"></i> Project Completed!
          {% elif completion_percentage >= 75 %}
            <i class="bi bi-hourglass-split text-info"></i> Almost There!
          {% elif completion_percentage >= 50 %}
            <i class="bi bi-hourglass text-warning"></i> Halfway Through!
          {% elif completion_percentage > 0 %}
            <i class="bi bi-play-circle text-danger"></i> Just Getting Started!
          {% else %}
            <i class="bi bi-exclamation-triangle text-danger"></i> No Milestones Completed Yet.
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>



<!-- Milestones Data Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-table"></i> Milestones</h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-danger" id="deleteSelectedBtn" disabled onclick="deleteSelected()">
                        <i class="bi bi-trash"></i> Delete Selected
                    </button>
                    <a href="/add-milestone/{{ project.id }}" class="btn btn-sm btn-light"><i class="bi bi-plus-circle"></i> Add Milestone</a>
                </div>
            </div>
            <div class="card-body">
                {% if project.milestones %}
                <form id="deleteMilestonesForm" method="post" action="/delete-milestones">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center" style="width:50px;">
                                        <input type="checkbox" id="selectAll" class="form-check-input" style="width: 20px; height: 20px;" onchange="toggleSelectAll(this)">
                                    </th>
                                    <th>Milestone Name</th>
                                    <th style="width: 130px;">Start Date</th>
                                    <th style="width: 130px;">End Date</th>
                                    <th style="width: 150px;" class="text-center">Priority</th>
                                    <th style="width: 200px;" class="text-center">Status</th>
                                    <th style="width: 150px;" class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for milestone in project.milestones %}
                                <tr>
                                    <td class="text-center">
                                        <input type="checkbox" name="milestone_ids" value="{{ milestone.id }}"
                                               class="form-check-input milestone-checkbox"
                                               style="width: 20px; height: 20px;"
                                               onchange="updateDeleteButton()">
                                    </td>
                                    <td><strong><i class="bi bi-flag-fill me-2"></i>{{ milestone.milestone_name }}</strong></td>
                                    <td>{{ milestone.start_date.strftime('%d-%m-%Y') }}</td>
                                    <td>{{ milestone.end_date.strftime('%d-%m-%Y') }}</td>
                                    <td class="text-center">
                                        {% if milestone.priority == "High" %}
                                            <span class="badge bg-danger">ðŸ”´ High</span>
                                        {% elif milestone.priority == "Medium" %}
                                            <span class="badge bg-warning text-dark">ðŸŸ¡ Medium</span>
                                        {% elif milestone.priority == "Low" %}
                                            <span class="badge bg-success">ðŸŸ¢ Low</span>
                                        {% else %}
                                            <span class="badge bg-secondary">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% set display_status = milestone.status %}
                                        {% if today > milestone.end_date and milestone.status != 'Completed' %}
                                            {% set display_status = 'Overdue' %}
                                        {% elif today < milestone.start_date and milestone.status == 'In Progress' %}
                                            {% set display_status = 'Not Started' %}
                                        {% endif %}
                                        
                                        <span class="badge {% if display_status == 'Completed' %}bg-success{% elif display_status == 'Overdue' %}bg-danger{% elif display_status == 'In Progress' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                            {% if display_status == 'Completed' %}âœ“ Completed{% elif display_status == 'Overdue' %}âš  Overdue{% elif display_status == 'In Progress' %}In Progress{% else %}Not Started{% endif %}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('edit_milestone', milestone_id=milestone.id) }}" class="btn btn-sm btn-primary">
                                            <i class="bi bi-pencil-square"></i> Edit
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-table text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">No Milestones Yet</h5>
                    <p class="text-muted">Get Started By Creating Your First Milestone</p>
                    <a href="/add-milestone/{{ project.id }}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add Your First Milestone</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Danger Zone -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card shadow border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Danger Zone</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-2"><strong>Delete This Project</strong></h6>
                        <p class="text-muted mb-0">
                            <i class="bi bi-info-circle"></i>
                            Once you delete this project, there is no going back. This action will permanently delete
                            <strong>{{ project.project_name }}</strong> and all its milestones.
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="#" class="btn btn-danger btn-lg" onclick="showDeleteProjectModal('{{ project.id }}', '{{ project.project_name }}'); return false;">
                            <i class="bi bi-trash-fill"></i> Delete Project
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ===== DELETION FUNCTIONS =====
function updateDeleteButton() {
    const checkboxes = document.querySelectorAll('.milestone-checkbox');
    let checkedCount = 0;
    checkboxes.forEach(cb => { if (cb.checked) checkedCount++; });
    document.getElementById('deleteSelectedBtn').disabled = checkedCount === 0;
    const selectAll = document.getElementById('selectAll');
    if (selectAll) {
        selectAll.checked = (checkedCount === checkboxes.length && checkboxes.length > 0);
        selectAll.indeterminate = (checkedCount > 0 && checkedCount < checkboxes.length);
    }
}

function toggleSelectAll(selectAllBox) {
    const checkboxes = document.querySelectorAll('.milestone-checkbox');
    checkboxes.forEach(cb => { cb.checked = selectAllBox.checked; });
    updateDeleteButton();
}

function deleteSelected() {
    const checkedCount = document.querySelectorAll('.milestone-checkbox:checked').length;
    if (checkedCount === 0) return;
    showDeleteMilestonesModal(checkedCount);
}

// ===== STATUS UPDATE FUNCTION =====
/*function updateMilestoneStatus(selectElement, milestoneId) {
    const newStatus = selectElement.value;
    const formData = new FormData();
    formData.append('status', newStatus);
    fetch(`/update-milestone-status/${milestoneId}`, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to update status. Please try again.');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}*/

document.addEventListener('DOMContentLoaded', updateDeleteButton);
</script>
{% endblock %}
